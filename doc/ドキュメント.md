
# VAS アセンブラ

* 日本語のドキュメンテーションはAI翻訳をつかっているので間違った日本語があるかもしれません。

VASは、x86-64 Linuxをサポートし、AT&Tアセンブリ構文を使用するシンプルなアセンブラです。このドキュメントでは、VASアセンブラを使用して、リンカーとリンクできるオブジェクトファイルを作成し、その結果の実行可能ファイルを実行する方法について説明します。

## インストール

VASを使用するには、システムにVプログラミング言語がインストールされている必要があります。https://github.com/vlang/v の手順に従って、Vをダウンロードしてインストールできます。

Vをインストールした後、GitリポジトリをクローンしてVASアセンブラをダウンロードすることができます。


```shell
git clone git@github.com:v420v/vas.git
```

リポジトリをクローンしたら、`vas`ディレクトリに移動して`make`コマンドを実行して、`vas`実行可能ファイルをビルドします。

```shell
cd vas
make
```

これで、vas実行可能ファイルがビルドされ、使用できるようになりました。

## 使い方

VASアセンブラを使用するには、アセンブルするアセンブリコードが含まれた新しいファイルを作成します。たとえば、以下のコードが含まれたhello.sという名前のファイルを作成してください。

```asm
.global _start

.section .text, "ax"
_start:
	pushq %rbp
	movq %rsp, %rbp
	subq $16, %rsp

	movq $1, %rax
	movq $1, %rdi
	leaq msg(%rip), %rsi
	movq $13, %rdx
	syscall

	movq $60, %rax
	movq $0, %rdi
	syscall

.section .data, "wa"
msg:
	.string "Hello, world!"

```

アセンブリコードを用意したら、vas実行可能ファイルを使用して、オブジェクトファイルにアセンブルできます。

```
./vas hello.s
```

これにより、hello.oという名前のオブジェクトファイルが作成されます。

オブジェクトファイルから実行可能ファイルを作成するには、リンカーを使用します。たとえば、`ld`リンカーを使用して、`hello.o`から`hello`という名前の実行可能ファイルを作成するには、次のコマンドを実行します。

```
ld -o hello hello.o
```

最後に、実行可能ファイルを実行します。

```
./hello
```

次の出力が表示されるはずです。

```
Hello, world!
```

その他の例はexamplesフォルダにあります。

## アセンブリ言語の構文

VAS は AT&T アセンブリ構文を使用しています。AT&T 構文と他のアセンブラで使用される Intel 構文の主な違いは以下の通りです。

```
    オペランドの順序：AT&T 構文では、ソースオペランドが左側にあり、宛先オペランドが右側にあります。
    レジスタの命名：AT&T 構文では、レジスタ名の前に % 文字が付きます（例： %rax、%rbp、%rsp）。
    即値：AT&T 構文では、即値の前に $ 文字が付きます（例： $1、$13）。
```

```

    命令 ソースオペランド, 宛先オペランド

```

## Supported instruction + Operation Suffixes

- [x] `pop`
- [x] `push`
- [x] `call`
- [x] `leaq`
- [x] `leal`
- [x] `leaw`
- [x] `notq`
- [x] `notl`
- [x] `notw`
- [x] `notb`
- [x] `negq`
- [x] `negl`
- [x] `negw`
- [x] `negb`
- [x] `divq`
- [x] `divl`
- [x] `divw`
- [x] `divb`
- [x] `idivq`
- [x] `idivl`
- [x] `idivw`
- [x] `idivb`
- [x] `imulq`
- [x] `imull`
- [x] `imulw`
- [x] `mulq`
- [x] `mull`
- [x] `mulw`
- [x] `mulb`
- [x] `movq`
- [x] `movl`
- [x] `movw`
- [x] `movb`
- [x] `movzbw`
- [x] `movzbl`
- [x] `movzbq`
- [x] `movzwq`
- [x] `movzwl`
- [x] `movsbl`
- [x] `movsbw`
- [x] `movsbq`
- [x] `movswl`
- [x] `movswq`
- [x] `movslq`
- [x] `movabsq`
- [x] `testq`
- [x] `testl`
- [x] `testw`
- [x] `testb`
- [x] `addq`
- [x] `addl`
- [x] `addw`
- [x] `addb`
- [x] `orq`
- [x] `orl`
- [x] `orw`
- [x] `orb`
- [x] `adcq`
- [x] `adcl`
- [x] `adcw`
- [x] `adcb`
- [x] `sbbq`
- [x] `sbbl`
- [x] `sbbw`
- [x] `sbbb`
- [x] `andq`
- [x] `andl`
- [x] `andw`
- [x] `andb`
- [x] `subq`
- [x] `subl`
- [x] `subw`
- [x] `subb`
- [x] `xorq`
- [x] `xorl`
- [x] `xorw`
- [x] `xorb`
- [x] `cmpq`
- [x] `cmpl`
- [x] `cmpw`
- [x] `cmpb`
- [x] `shlq`
- [x] `shll`
- [x] `shlw`
- [x] `shlb`
- [x] `shrq`
- [x] `shrl`
- [x] `shrw`
- [x] `shrb`
- [x] `sarq`
- [x] `sarl`
- [x] `sarw`
- [x] `sarb`
- [x] `salq`
- [x] `sall`
- [x] `salw`
- [x] `salb`
- [x] `seto`
- [x] `setno`
- [x] `setb`
- [x] `setae`
- [x] `sete`
- [x] `setne`
- [x] `setnb`
- [x] `setbe`
- [x] `seta`
- [x] `setpo`
- [x] `setl`
- [x] `setg`
- [x] `setle`
- [x] `setge`
- [x] `jmp`
- [x] `jne`
- [x] `je`
- [x] `jl`
- [x] `jg`
- [x] `jle`
- [x] `jge`
- [x] `jnb`
- [x] `jbe`
- [x] `jnbe`
- [x] `jp`
- [x] `ja`
- [x] `jb`
- [x] `js`
- [x] `jns`
- [x] `rep`
- [x] `cvttss2sil`
- [x] `cvtsi2ssq`
- [x] `cvtsi2sdq`
- [x] `movd`
- [x] `xorpd`
- [x] `xorps`
- [x] `movss`
- [x] `movsd`
- [x] `movaps`
- [x] `movups`
- [x] `pxor`
- [x] `cvtsd2ss`
- [x] `cvtss2sd`
- [x] `ucomiss`
- [x] `ucomisd`
- [x] `comiss`
- [x] `comisd`
- [x] `subss`
- [x] `subsd`
- [x] `addss`
- [x] `addsd`
- [x] `mulss`
- [x] `mulsd`
- [x] `divss`
- [x] `divsd`
- [x] `cmovsq`
- [x] `cmovsl`
- [x] `cmovsw`
- [x] `cmovnsq`
- [x] `cmovnsl`
- [x] `cmovnsw`
- [x] `cmovgeq`
- [x] `cmovgel`
- [x] `cmovgew`
- [x] `cmovlq`
- [x] `cmovll`
- [x] `cmovlw`
- [x] `cmovleq`
- [x] `cmovlel`
- [x] `cmovlew`
- [x] `cmovgq`
- [x] `cmovgl`
- [x] `cmovgw`
- [x] `ret`
- [x] `syscall`
- [x] `nop`
- [x] `hlt`
- [x] `leave`
- [x] `cltq`
- [x] `cltd`
- [x] `cqto`
- [x] `cwtl`
- [ ] ...

## ローカルシンボル
`.L` から始まるシンボルは無視されます。

```asm
.global _start

_start:
    movq $1, %rax
    movq $1, %rdi
    leaq .L1(%rip), %rsi
    movq $15, %rdx
    syscall

    movq $60, %rax
    movq $0, %rdi
    syscall

.section .data, "wa"
.L1:
 .string "Hello, world!\n"
```
```
┌──[~/vas]
└─$ ./vas main.s

┌──[~/vas]
└─$ readelf -s main.o                                  

Symbol table '.symtab' contains 3 entries:
  番号:      値         サイズ タイプ  Bind   Vis      索引名
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 SECTION LOCAL  DEFAULT    2 .data
     2: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT    1 _start
```

## アセンブラ ディレクティブ
`.string`
```asm
.string "Hello, world!"
```

`.byte` `.word` `.long` `.quad`
```asm
.section .data, "aw"

constant_string:
	.string "Hello\n"

.quad constant_string
.quad 0x10
.long 0x10
.word 0x10
.byte 0x10
```
```asm
.byte 0x72
.byte 0x101
.byte 0x108
.byte 0x108
.byte 0x111
.byte 0x44
.byte 0x32
.byte 0x119
.byte 0x111
.byte 0x114
.byte 0x108
.byte 0x100
.byte 0x33
```

`.section`
```asm
.section .text, "ax"
```
section attributes
- `a` alloc
- `w` write
- `x` execute

`.global`
```asm
.global symbol_name
```

`.local`
```asm
.local symbol_name
```

`.zero`
```asm
# 0 を n 回置く
.zero 10
.zero 10
```
